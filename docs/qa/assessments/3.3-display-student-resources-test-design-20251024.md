# Test Design: Story 3.3 - Display Student Resources

**Date:** 2025-10-24
**Designer:** Quinn (Test Architect)
**Story:** 3.3 - Display Student Resources
**Status:** Ready for Review

## Test Strategy Overview

- **Total test scenarios:** 24
- **Unit tests:** 6 (25%)
- **Integration tests:** 13 (54%)
- **E2E tests:** 5 (21%)
- **Priority distribution:** P0: 11, P1: 9, P2: 4

### Test Philosophy

This story involves file download functionality with critical security requirements (authorization), database interactions, and user interface components. The test strategy prioritizes:

1. **Security-first:** Authorization checks are P0 and tested at multiple levels
2. **Shift-left:** Database queries and API logic tested at integration level
3. **User journey validation:** Critical download path covered E2E
4. **Efficient coverage:** Avoid redundant tests across levels

---

## Test Scenarios by Acceptance Criteria

### AC1: "My Resources" section queries database for files associated with logged-in student

#### Scenarios

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 3.3-INT-001 | Integration | P0 | Fetch resources for authenticated student with valid clerkUserId | Validates core DB query logic |
| 3.3-INT-002 | Integration | P0 | Return empty array when student has no resources | Ensures correct empty state handling |
| 3.3-INT-003 | Integration | P1 | Return 401 when no userId in auth context | Security validation |
| 3.3-INT-004 | Integration | P1 | Return 404 when clerkUserId doesn't match any student | User mapping validation |

**Risk Coverage:** AUTH-001 (Unauthenticated access), DB-001 (Query failure)

---

### AC2: Files displayed in list or card format with filename, file type, upload date

#### Scenarios

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 3.3-INT-005 | Integration | P1 | API returns all required fields (id, filename, mimeType, fileSize, createdAt) | Data contract validation |
| 3.3-COMP-001 | Component | P1 | ResourcesList renders resource cards with all metadata | UI rendering validation |
| 3.3-COMP-002 | Component | P1 | Display correct file type icon based on mimeType | UI presentation validation |
| 3.3-UNIT-001 | Unit | P2 | File size formatter converts bytes to MB correctly | Pure calculation logic |
| 3.3-UNIT-002 | Unit | P2 | Date formatter displays in user's locale | Formatting logic |

**Risk Coverage:** UI-001 (Display errors)

---

### AC3: Each file has "Download" button that triggers file download

#### Scenarios

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 3.3-COMP-003 | Component | P0 | Download button calls download API with correct resource ID | User interaction validation |
| 3.3-COMP-004 | Component | P1 | Download button shows loading state during download | UX feedback validation |
| 3.3-E2E-001 | E2E | P0 | User clicks download and file downloads with correct filename | Critical user journey |
| 3.3-E2E-002 | E2E | P1 | Downloaded file has correct MIME type and content | File integrity validation |

**Risk Coverage:** FUNC-001 (Download failure)

---

### AC4: Downloads served via API route (`/api/resources/[id]`) with authentication check

#### Scenarios

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 3.3-INT-006 | Integration | P0 | Download API returns file data with correct headers | Core API functionality |
| 3.3-INT-007 | Integration | P0 | Download API returns 401 when no userId in auth | Security validation |
| 3.3-INT-008 | Integration | P0 | Download API sets Content-Disposition header with filename | Browser download behavior |
| 3.3-INT-009 | Integration | P1 | Download API sets correct Content-Type from mimeType | File handling validation |
| 3.3-INT-010 | Integration | P1 | Download API returns 404 when resource ID doesn't exist | Error handling |

**Risk Coverage:** AUTH-002 (Missing auth check), FUNC-002 (Incorrect headers)

---

### AC5: Only student's own files accessible (authorization check)

#### Scenarios

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 3.3-INT-011 | Integration | P0 | Download API returns 403 when resource belongs to different student | **CRITICAL SECURITY** |
| 3.3-E2E-003 | E2E | P0 | User cannot access another student's resource URL directly | Security validation in real context |
| 3.3-UNIT-003 | Unit | P1 | Authorization check logic correctly compares studentId | Isolation test of auth logic |

**Risk Coverage:** SEC-001 (Authorization bypass) - **HIGHEST PRIORITY**

---

### AC6: Files sorted by upload date (newest first)

#### Scenarios

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 3.3-INT-012 | Integration | P1 | API returns resources ordered by createdAt DESC | Database query validation |
| 3.3-UNIT-004 | Unit | P2 | Sort function handles edge case: same createdAt timestamps | Edge case logic |

**Risk Coverage:** None (Low-risk sorting feature)

---

### AC7: Empty state: "No resources yet. Your instructor will upload materials here."

#### Scenarios

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 3.3-COMP-005 | Component | P1 | Display empty state message when resources array is empty | UX validation |
| 3.3-E2E-004 | E2E | P2 | New student sees empty state on first login | User journey validation |

**Risk Coverage:** UX-001 (Confusing empty state)

---

## Additional Edge Case Scenarios

### Large Files & Performance

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 3.3-INT-013 | Integration | P1 | Download API handles 50MB file without timeout | Performance validation |
| 3.3-E2E-005 | E2E | P2 | Download progress indicator shows for large files | UX validation |

### Error Handling

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 3.3-COMP-006 | Component | P1 | Display error message when fetch fails | Error UX validation |
| 3.3-COMP-007 | Component | P2 | Handle corrupted file data gracefully | Resilience validation |
| 3.3-UNIT-005 | Unit | P2 | Default MIME type to application/octet-stream when missing | Fallback logic |

### Network Resilience

| ID | Level | Priority | Test Description | Justification |
|----|-------|----------|------------------|---------------|
| 3.3-UNIT-006 | Unit | P2 | Retry logic triggers on network failure (if implemented) | Resilience logic |

---

## Risk Coverage Matrix

| Risk ID | Description | Mitigating Tests | Severity |
|---------|-------------|------------------|----------|
| SEC-001 | Authorization bypass allows access to other students' files | 3.3-INT-011, 3.3-E2E-003, 3.3-UNIT-003 | **CRITICAL** |
| AUTH-001 | Unauthenticated users access resources | 3.3-INT-003, 3.3-INT-007 | High |
| AUTH-002 | Missing authentication check in download API | 3.3-INT-007 | High |
| FUNC-001 | Download fails due to incorrect implementation | 3.3-E2E-001, 3.3-COMP-003, 3.3-INT-006 | Medium |
| FUNC-002 | Incorrect headers break browser download | 3.3-INT-008, 3.3-INT-009 | Medium |
| DB-001 | Database query fails or returns wrong data | 3.3-INT-001, 3.3-INT-012 | Medium |
| UI-001 | Display errors confuse users | 3.3-COMP-001, 3.3-COMP-002 | Low |
| UX-001 | Empty state not shown properly | 3.3-COMP-005, 3.3-E2E-004 | Low |

---

## Recommended Execution Order

### Phase 1: Security & Core Functionality (P0)
**Objective:** Fail fast on critical security and functionality issues

1. **3.3-INT-011** - Authorization check (CRITICAL)
2. **3.3-INT-007** - Authentication check in download API
3. **3.3-INT-001** - Core database query
4. **3.3-INT-006** - Download API functionality
5. **3.3-E2E-003** - Authorization in user context
6. **3.3-E2E-001** - Critical download journey
7. **3.3-COMP-003** - Download button interaction

### Phase 2: Integration & User Experience (P1)
**Objective:** Validate component interactions and user flows

8. **3.3-INT-003** through **3.3-INT-005** - API edge cases
9. **3.3-INT-008** through **3.3-INT-013** - Headers, errors, performance
10. **3.3-COMP-001**, **3.3-COMP-002** - UI rendering
11. **3.3-COMP-004**, **3.3-COMP-005**, **3.3-COMP-006** - UX states
12. **3.3-E2E-002** - File integrity
13. **3.3-UNIT-003** - Authorization logic unit test

### Phase 3: Polish & Edge Cases (P2)
**Objective:** Cover edge cases and nice-to-have features

14. **3.3-UNIT-001**, **3.3-UNIT-002**, **3.3-UNIT-004** through **3.3-UNIT-006** - Formatting and logic
15. **3.3-COMP-007** - Error resilience
16. **3.3-E2E-004**, **3.3-E2E-005** - Secondary user journeys

---

## Test Implementation Recommendations

### Unit Tests (`/app/tests/utils/`)
- File size formatter (bytes → MB)
- Date formatter
- MIME type defaulting logic
- Authorization comparison logic
- Sort edge cases

**Framework:** Jest
**Estimated duration:** < 1 second total

---

### Integration Tests (`/app/tests/api/`)

#### `/api/resources` (List endpoint)
- ✅ Fetch resources for authenticated student
- ✅ Return empty array for student with no resources
- ✅ Return 401 when unauthenticated
- ✅ Return 404 when student not found
- ✅ Return resources ordered by createdAt DESC

#### `/api/resources/[id]` (Download endpoint)
- ✅ Download file with correct headers and data
- ✅ Return 401 when unauthenticated
- ✅ Return 403 when resource belongs to different student (CRITICAL)
- ✅ Return 404 when resource doesn't exist
- ✅ Set Content-Disposition header correctly
- ✅ Set Content-Type from mimeType
- ✅ Handle 50MB files without timeout

**Framework:** Jest + Supertest + Prisma test database
**Setup:** Mock Clerk auth, seed test data
**Estimated duration:** 2-5 seconds

---

### Component Tests (`/app/tests/components/`)

#### `ResourcesList.tsx`
- Render resource cards with all metadata
- Display correct file type icons
- Call download API on button click
- Show loading state during download
- Display empty state when no resources
- Display error message on fetch failure
- Handle corrupted data gracefully

**Framework:** React Testing Library + Jest
**Mocking:** API calls, Clerk useUser hook
**Estimated duration:** 1-3 seconds

---

### E2E Tests (`/app/tests/e2e/`)

#### Critical User Journeys
1. **Student downloads own resource** (P0)
   - Login as student
   - Navigate to dashboard
   - Click download button
   - Verify file downloads with correct filename

2. **Authorization enforcement** (P0)
   - Login as Student A
   - Attempt to access Student B's resource URL directly
   - Verify 403 error or redirect

3. **File integrity** (P1)
   - Download file
   - Verify MIME type matches expected
   - Verify file content is correct

4. **Empty state for new student** (P2)
   - Login as new student with no resources
   - Verify empty state message displays

5. **Large file download with progress** (P2)
   - Download 50MB file
   - Verify progress indicator shows

**Framework:** Playwright
**Environment:** Clerk test mode + seeded database
**Estimated duration:** 20-40 seconds

---

## Coverage Gaps Analysis

### Complete Coverage ✅
- All 7 Acceptance Criteria have test coverage
- Security requirements (AC5) tested at 3 levels (unit, integration, E2E)
- Critical paths have redundant coverage

### No Gaps Identified

---

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (not over-testing)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk (authorization = P0)
- [x] Test IDs follow naming convention (3.3-LEVEL-NNN)
- [x] Scenarios are atomic and independent
- [x] Security tests prioritized at multiple levels
- [x] Performance considerations included (50MB files)
- [x] Error handling and edge cases covered

---

## Key Principles Applied

✅ **Shift left:** Authorization logic tested at unit level, then integration, then E2E
✅ **Risk-based:** Security tests are P0, formatting tests are P2
✅ **Efficient coverage:** MIME type validation at integration level only, not duplicated
✅ **Maintainability:** Integration tests run fast with mocked auth
✅ **Fast feedback:** Unit tests < 1s, Integration tests < 5s

---

## Notes for Developers

1. **Authorization is CRITICAL:** Tests 3.3-INT-011 and 3.3-E2E-003 MUST pass before deployment
2. **Test data seeding:** Create at least 3 test students with different resources for proper isolation
3. **Clerk mocking:** Use Clerk's test mode or mock the `auth()` function consistently
4. **File storage:** Consider using test fixtures for file data instead of real 50MB files in CI
5. **Parallel execution:** Integration tests should be independent and runnable in parallel

---

## Test Execution Metrics (Target)

| Metric | Target | Rationale |
|--------|--------|-----------|
| Total test suite duration | < 60 seconds | Fast feedback loop |
| Unit test duration | < 1 second | Instant validation |
| Integration test duration | < 5 seconds | Quick API validation |
| E2E test duration | < 40 seconds | Acceptable for critical paths |
| Code coverage (lines) | > 80% | Industry standard |
| Code coverage (branches) | > 75% | Error paths covered |
| P0 tests pass rate | 100% | Non-negotiable |

---

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 24
  by_level:
    unit: 6
    integration: 13
    component: 7
    e2e: 5
  by_priority:
    p0: 11
    p1: 9
    p2: 4
  coverage_gaps: []
  security_tests: 5
  critical_risks_covered:
    - SEC-001: Authorization bypass (3 tests)
    - AUTH-001: Unauthenticated access (2 tests)
    - AUTH-002: Missing auth check (1 test)
```

---

## Traceability Reference

**Test design matrix:** `docs/qa/assessments/3.3-display-student-resources-test-design-20251024.md`
**P0 tests identified:** 11
**Security-critical tests:** 5
**Recommended for quality gate:** PASS with conditions (P0 tests must pass)
