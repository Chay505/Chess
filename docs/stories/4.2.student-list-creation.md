# Story 4.2: Student List & Manual Student Creation

## Status
Draft

## Story
**As the** instructor,
**I want** list of all students with ability to manually add new students,
**so that** I can grant portal access to students after they book lessons.

## Acceptance Criteria
1. Admin page at `/admin/students` displays list of all students
2. List shows: student name, email, date added, number of resources/feedback
3. "Add Student" button opens form to create new student manually
4. Form collects: name, email, preferred language (FR/EN)
5. Form submission creates Clerk user (sends invitation email) and `Student` database record
6. Student list searchable/filterable by name or email
7. Click student name navigates to student detail page

## Tasks / Subtasks
- [ ] Create students list page (AC: 1)
  - [ ] Create `/app/[locale]/admin/students/page.tsx`
  - [ ] Fetch all students from database with Prisma
  - [ ] Include resource count and feedback count in query
  - [ ] Display students in table format
- [ ] Display student information (AC: 2)
  - [ ] Create table columns: Name, Email, Date Added, Resources, Feedback, Actions
  - [ ] Format date as readable string
  - [ ] Add "View Details" button/link for each student
  - [ ] Style table responsively (cards on mobile)
- [ ] Create "Add Student" button and form (AC: 3, 4)
  - [ ] Add "Add Student" button at top of page
  - [ ] Create modal or separate page for student creation form
  - [ ] Form fields: Name (text), Email (email), Preferred Language (dropdown: EN/FR)
  - [ ] Add form validation (required fields, email format)
- [ ] Implement student creation logic (AC: 5)
  - [ ] Create API route: `/app/api/admin/students/route.ts`
  - [ ] Verify user has instructor role
  - [ ] Create Clerk user via Clerk API
  - [ ] Send invitation email to student (Clerk handles)
  - [ ] Create `Student` record in database with `clerkUserId`
  - [ ] Return success/error response
- [ ] Add search/filter functionality (AC: 6)
  - [ ] Add search input field above table
  - [ ] Filter students by name or email (client-side or server-side)
  - [ ] Update table display based on search query
- [ ] Add navigation to student detail (AC: 7)
  - [ ] Make student name clickable link
  - [ ] Link to `/admin/students/[id]` (to be created in Story 4.3)
  - [ ] Pass student ID in URL

## Dev Notes

### Component Specifications
- **Students List Page:** `/app/[locale]/admin/students/page.tsx`
- **Add Student Modal:** `/components/admin/AddStudentModal.tsx` or separate page
- **API Route:** `/app/api/admin/students/route.ts`
- **Database Query:** Prisma query with resource/feedback counts

### Design Details from Front-End Spec
**Students List Layout:**
- Page heading: "Students" with "Add Student" button (top-right)
- Search bar: Filter by name or email
- Table (desktop) or cards (mobile)
- Table columns: Name, Email, Date Added, Resources Count, Feedback Count, Actions

**Table Design:**
- Header: Gray background (#F3F4F6)
- Rows: Alternating white and light gray backgrounds
- Hover: Highlight row on hover
- Responsive: Switch to card layout on mobile (<768px)

**Add Student Form:**
- Modal or separate page
- Fields: Name, Email, Preferred Language
- Submit button: "Create Student Account"
- Cancel button: Close modal or return to list

**Typography:**
- Page heading: H1, 32px, weight 600
- Table headers: 14px, weight 600, uppercase
- Table cells: 16px, weight 400

### Prisma Query with Counts
```ts
const students = await prisma.student.findMany({
  include: {
    _count: {
      select: {
        resources: true,
        feedback: true
      }
    }
  },
  orderBy: { createdAt: 'desc' }
});
```

### Example Code Structure
```tsx
// app/[locale]/admin/students/page.tsx
'use client';
import { useState, useEffect } from 'react';
import { useTranslations } from 'next-intl';
import Link from 'next/link';
import AddStudentModal from '@/components/admin/AddStudentModal';

interface Student {
  id: string;
  name: string;
  email: string;
  createdAt: string;
  _count: {
    resources: number;
    feedback: number;
  };
}

export default function StudentsPage() {
  const t = useTranslations('admin.students');
  const [students, setStudents] = useState<Student[]>([]);
  const [searchQuery, setSearchQuery] = useState('');
  const [showAddModal, setShowAddModal] = useState(false);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchStudents();
  }, []);

  const fetchStudents = async () => {
    try {
      const res = await fetch('/api/admin/students');
      const data = await res.json();
      setStudents(data.students || []);
    } catch (error) {
      console.error('Failed to fetch students:', error);
    } finally {
      setLoading(false);
    }
  };

  const filteredStudents = students.filter(
    (student) =>
      student.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
      student.email.toLowerCase().includes(searchQuery.toLowerCase())
  );

  if (loading) {
    return <div className="text-center py-12">{t('loading')}</div>;
  }

  return (
    <div>
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-3xl font-semibold text-gray-800">{t('heading')}</h1>
        <button
          onClick={() => setShowAddModal(true)}
          className="bg-teal-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-teal-700 transition"
        >
          {t('addStudent')}
        </button>
      </div>

      <div className="mb-6">
        <input
          type="text"
          placeholder={t('search')}
          value={searchQuery}
          onChange={(e) => setSearchQuery(e.target.value)}
          className="w-full md:w-96 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"
        />
      </div>

      <div className="bg-white rounded-lg shadow-md overflow-hidden">
        <table className="w-full">
          <thead className="bg-gray-50 border-b border-gray-200">
            <tr>
              <th className="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">
                {t('table.name')}
              </th>
              <th className="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">
                {t('table.email')}
              </th>
              <th className="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">
                {t('table.dateAdded')}
              </th>
              <th className="px-6 py-3 text-center text-xs font-semibold text-gray-700 uppercase">
                {t('table.resources')}
              </th>
              <th className="px-6 py-3 text-center text-xs font-semibold text-gray-700 uppercase">
                {t('table.feedback')}
              </th>
              <th className="px-6 py-3 text-center text-xs font-semibold text-gray-700 uppercase">
                {t('table.actions')}
              </th>
            </tr>
          </thead>
          <tbody>
            {filteredStudents.map((student) => (
              <tr key={student.id} className="border-b border-gray-200 hover:bg-gray-50 transition">
                <td className="px-6 py-4">
                  <Link
                    href={`/admin/students/${student.id}`}
                    className="text-teal-600 hover:text-teal-800 font-medium"
                  >
                    {student.name}
                  </Link>
                </td>
                <td className="px-6 py-4 text-gray-600">{student.email}</td>
                <td className="px-6 py-4 text-gray-600">
                  {new Date(student.createdAt).toLocaleDateString()}
                </td>
                <td className="px-6 py-4 text-center text-gray-600">
                  {student._count.resources}
                </td>
                <td className="px-6 py-4 text-center text-gray-600">
                  {student._count.feedback}
                </td>
                <td className="px-6 py-4 text-center">
                  <Link
                    href={`/admin/students/${student.id}`}
                    className="text-teal-600 hover:text-teal-800 text-sm"
                  >
                    {t('viewDetails')}
                  </Link>
                </td>
              </tr>
            ))}
          </tbody>
        </table>

        {filteredStudents.length === 0 && (
          <div className="text-center py-12 text-gray-500">{t('noResults')}</div>
        )}
      </div>

      {showAddModal && (
        <AddStudentModal
          onClose={() => setShowAddModal(false)}
          onSuccess={() => {
            setShowAddModal(false);
            fetchStudents();
          }}
        />
      )}
    </div>
  );
}
```

```tsx
// components/admin/AddStudentModal.tsx
'use client';
import { useState } from 'react';
import { useTranslations } from 'next-intl';
import { XMarkIcon } from '@heroicons/react/24/outline';

export default function AddStudentModal({
  onClose,
  onSuccess
}: {
  onClose: () => void;
  onSuccess: () => void;
}) {
  const t = useTranslations('admin.students.addModal');
  const [formData, setFormData] = useState({
    name: '',
    email: '',
    preferredLanguage: 'en'
  });
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError('');

    try {
      const res = await fetch('/api/admin/students', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });

      if (res.ok) {
        onSuccess();
      } else {
        const data = await res.json();
        setError(data.error || 'Failed to create student');
      }
    } catch (err) {
      setError('Failed to create student');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
        <div className="flex justify-between items-center mb-6">
          <h2 className="text-2xl font-semibold text-gray-800">{t('heading')}</h2>
          <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
            <XMarkIcon className="w-6 h-6" />
          </button>
        </div>

        <form onSubmit={handleSubmit}>
          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700 mb-2">
              {t('name')} *
            </label>
            <input
              type="text"
              required
              value={formData.name}
              onChange={(e) => setFormData({ ...formData, name: e.target.value })}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"
            />
          </div>

          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700 mb-2">
              {t('email')} *
            </label>
            <input
              type="email"
              required
              value={formData.email}
              onChange={(e) => setFormData({ ...formData, email: e.target.value })}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"
            />
          </div>

          <div className="mb-6">
            <label className="block text-sm font-medium text-gray-700 mb-2">
              {t('language')}
            </label>
            <select
              value={formData.preferredLanguage}
              onChange={(e) => setFormData({ ...formData, preferredLanguage: e.target.value })}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"
            >
              <option value="en">English</option>
              <option value="fr">Français</option>
            </select>
          </div>

          {error && (
            <div className="mb-4 p-3 bg-red-50 border border-red-200 text-red-800 rounded-lg text-sm">
              {error}
            </div>
          )}

          <div className="flex space-x-4">
            <button
              type="button"
              onClick={onClose}
              className="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition"
            >
              {t('cancel')}
            </button>
            <button
              type="submit"
              disabled={loading}
              className="flex-1 bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition disabled:opacity-50"
            >
              {loading ? t('creating') : t('create')}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}
```

```ts
// app/api/admin/students/route.ts
import { auth } from '@clerk/nextjs';
import { NextResponse } from 'next/server';
import { clerkClient } from '@clerk/nextjs/server';
import prisma from '@/lib/prisma';

// GET: Fetch all students
export async function GET() {
  try {
    const { userId, sessionClaims } = auth();

    if (!userId || sessionClaims?.metadata?.role !== 'instructor') {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 403 });
    }

    const students = await prisma.student.findMany({
      include: {
        _count: {
          select: {
            resources: true,
            feedback: true
          }
        }
      },
      orderBy: { createdAt: 'desc' }
    });

    return NextResponse.json({ students });
  } catch (error) {
    console.error('Error fetching students:', error);
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });
  }
}

// POST: Create new student
export async function POST(request: Request) {
  try {
    const { userId, sessionClaims } = auth();

    if (!userId || sessionClaims?.metadata?.role !== 'instructor') {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 403 });
    }

    const { name, email, preferredLanguage } = await request.json();

    // Create Clerk user
    const clerkUser = await clerkClient.users.createUser({
      emailAddress: [email],
      firstName: name.split(' ')[0],
      lastName: name.split(' ').slice(1).join(' ') || '',
      publicMetadata: { role: 'student' }
    });

    // Create Student record in database
    const student = await prisma.student.create({
      data: {
        clerkUserId: clerkUser.id,
        name,
        email,
        preferredLanguage
      }
    });

    return NextResponse.json({ student });
  } catch (error) {
    console.error('Error creating student:', error);
    return NextResponse.json({ error: 'Failed to create student' }, { status: 500 });
  }
}
```

### Translation Keys Example
```json
// messages/en.json
{
  "admin": {
    "students": {
      "heading": "Students",
      "addStudent": "Add Student",
      "search": "Search by name or email...",
      "loading": "Loading students...",
      "noResults": "No students found",
      "viewDetails": "View Details",
      "table": {
        "name": "Name",
        "email": "Email",
        "dateAdded": "Date Added",
        "resources": "Resources",
        "feedback": "Feedback",
        "actions": "Actions"
      },
      "addModal": {
        "heading": "Add New Student",
        "name": "Full Name",
        "email": "Email Address",
        "language": "Preferred Language",
        "create": "Create Student",
        "creating": "Creating...",
        "cancel": "Cancel"
      }
    }
  }
}
```

### Testing
- **List Display:** Access `/admin/students` and verify students list displays
- **Search:** Type in search box and verify filtering works
- **Add Student:** Click "Add Student", fill form, submit, verify success
- **Clerk User Creation:** Verify student receives invitation email from Clerk
- **Database Record:** Verify `Student` record created in database
- **Navigation:** Click student name and verify navigation to detail page
- **Authorization:** Log in as student, try accessing `/admin/students`, verify redirect

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | 1.0 | Initial story creation | John (PM Agent) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
