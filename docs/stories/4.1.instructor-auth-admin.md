# Story 4.1: Instructor Authentication & Admin Access

## Status
Draft

## Dependencies
- ✅ **REQUIRED**: Story 3.1 (Clerk Authentication) must be completed first
  - Needs Clerk configured with role-based access control
- ✅ **REQUIRED**: Story 1.4 (Prisma ORM) for database stats queries

## Story
**As the** instructor,
**I want** separate admin login that grants access to instructor-only admin panel,
**so that** I can manage students and upload resources without accessing student portal.

## Acceptance Criteria
1. Instructor account created manually in Clerk with admin role/metadata
2. Admin panel routes protected at `/admin/*` with Clerk role check
3. Middleware verifies user has instructor/admin role before allowing access
4. Non-admin users redirected to student dashboard if accessing `/admin`
5. Admin navigation separate from student portal navigation
6. Logout button in admin panel

## Tasks / Subtasks
- [ ] Configure instructor role in Clerk (AC: 1)
  - [ ] Create custom user metadata field: `role` in Clerk dashboard
  - [ ] Manually create instructor account via Clerk dashboard
  - [ ] Set `role` metadata to "instructor" for instructor account
  - [ ] Document instructor credentials securely
- [ ] Create admin middleware (AC: 2, 3)
  - [ ] Update `/middleware.ts` to check user role
  - [ ] Protect `/admin/*` routes with role check
  - [ ] Allow access only if `user.publicMetadata.role === "instructor"`
  - [ ] Redirect unauthorized users to `/dashboard` or `/login`
- [ ] Create admin layout (AC: 5, 6)
  - [ ] Create `/app/[locale]/admin/layout.tsx`
  - [ ] Create admin navigation component
  - [ ] Include: Dashboard, Students, Settings, Logout
  - [ ] Style admin header differently from student portal
  - [ ] Add Clerk `<SignOutButton>` for logout
- [ ] Test role-based access (AC: 4)
  - [ ] Log in as student, try accessing `/admin`
  - [ ] Verify redirect to `/dashboard`
  - [ ] Log in as instructor, verify `/admin` access granted
  - [ ] Test middleware role check logic
- [ ] Create admin dashboard page
  - [ ] Create `/app/[locale]/admin/page.tsx`
  - [ ] Display welcome message for instructor
  - [ ] Show quick stats: Total students, total resources, total feedback
  - [ ] Add navigation cards to Students, Upload Resources sections

## Dev Notes

### Component Specifications
- **Middleware:** `/middleware.ts` (updated with role check)
- **Admin Layout:** `/app/[locale]/admin/layout.tsx`
- **Admin Dashboard:** `/app/[locale]/admin/page.tsx`
- **Admin Header:** `/components/admin/AdminHeader.tsx`

### Clerk Role Configuration
**Custom Metadata Field:**
- Field name: `role`
- Type: String
- Values: "student" or "instructor"

**Setting Instructor Role:**
1. Go to Clerk Dashboard > Users
2. Create or select instructor user
3. Go to Metadata tab
4. Add public metadata: `{ "role": "instructor" }`

### Design Details from Front-End Spec
**Admin Panel Design:**
- Distinct from student portal (darker header, different color scheme)
- Header background: `#2C3E50` (dark blue-gray)
- Header text: White (#FFFFFF)
- Navigation: Sidebar on desktop, top bar on mobile

**Admin Header:**
- Logo + "Admin Panel" label
- Navigation links: Dashboard, Students, Settings
- User info + logout button (right side)

**Typography:**
- Same as student portal but with admin-specific branding
- Admin badge or label to distinguish from student portal

### Example Code Structure
```ts
// middleware.ts (updated)
import { authMiddleware } from '@clerk/nextjs';
import { NextResponse } from 'next/server';

export default authMiddleware({
  publicRoutes: ['/', '/en', '/fr', '/en/(.*)', '/fr/(.*)', '/payment'],

  afterAuth(auth, req) {
    // Allow public routes
    if (auth.isPublicRoute) {
      return NextResponse.next();
    }

    // Require authentication for protected routes
    if (!auth.userId) {
      const loginUrl = new URL('/login', req.url);
      loginUrl.searchParams.set('redirect_url', req.url);
      return NextResponse.redirect(loginUrl);
    }

    // Check admin role for /admin routes
    if (req.nextUrl.pathname.startsWith('/admin')) {
      const role = auth.sessionClaims?.metadata?.role;

      if (role !== 'instructor') {
        // Redirect non-instructors to student dashboard
        return NextResponse.redirect(new URL('/dashboard', req.url));
      }
    }

    return NextResponse.next();
  }
});

export const config = {
  matcher: ['/((?!.+\\.[\\w]+$|_next).*)', '/', '/(api|trpc)(.*)']
};
```

```tsx
// app/[locale]/admin/layout.tsx
import { auth } from '@clerk/nextjs';
import { redirect } from 'next/navigation';
import AdminHeader from '@/components/admin/AdminHeader';

export default async function AdminLayout({
  children
}: {
  children: React.ReactNode;
}) {
  const { userId, sessionClaims } = auth();

  // Verify user is authenticated and has instructor role
  if (!userId || sessionClaims?.metadata?.role !== 'instructor') {
    redirect('/dashboard');
  }

  return (
    <div className="min-h-screen bg-gray-100">
      <AdminHeader />
      <main className="max-w-7xl mx-auto px-6 py-8">
        {children}
      </main>
    </div>
  );
}
```

```tsx
// components/admin/AdminHeader.tsx
'use client';
import { useUser, SignOutButton } from '@clerk/nextjs';
import { useTranslations } from 'next-intl';
import Link from 'next/link';

export default function AdminHeader() {
  const { user } = useUser();
  const t = useTranslations('admin');

  return (
    <header className="bg-gray-800 text-white">
      <div className="max-w-7xl mx-auto px-6 py-4">
        <div className="flex justify-between items-center">
          <div className="flex items-center space-x-8">
            <Link href="/admin" className="text-2xl font-bold">
              Chess Coach <span className="text-teal-400">Admin</span>
            </Link>
            <nav className="hidden md:flex space-x-6">
              <Link href="/admin" className="hover:text-teal-400 transition">
                {t('nav.dashboard')}
              </Link>
              <Link href="/admin/students" className="hover:text-teal-400 transition">
                {t('nav.students')}
              </Link>
            </nav>
          </div>

          <div className="flex items-center space-x-4">
            <span className="text-sm">{user?.fullName}</span>
            <SignOutButton>
              <button className="text-sm hover:text-teal-400 transition">
                {t('logout')}
              </button>
            </SignOutButton>
          </div>
        </div>
      </div>
    </header>
  );
}
```

```tsx
// app/[locale]/admin/page.tsx
import { auth } from '@clerk/nextjs';
import { useTranslations } from 'next-intl';
import prisma from '@/lib/prisma';
import Link from 'next/link';

export default async function AdminDashboard() {
  const { userId } = auth();
  const t = useTranslations('admin.dashboard');

  // Fetch stats
  const totalStudents = await prisma.student.count();
  const totalResources = await prisma.resource.count();
  const totalFeedback = await prisma.feedback.count();

  return (
    <div>
      <h1 className="text-3xl font-semibold text-gray-800 mb-8">
        {t('heading')}
      </h1>

      <div className="grid md:grid-cols-3 gap-6 mb-8">
        <div className="bg-white rounded-lg shadow-md p-6">
          <div className="text-3xl font-bold text-teal-600">{totalStudents}</div>
          <div className="text-gray-600">{t('stats.students')}</div>
        </div>
        <div className="bg-white rounded-lg shadow-md p-6">
          <div className="text-3xl font-bold text-teal-600">{totalResources}</div>
          <div className="text-gray-600">{t('stats.resources')}</div>
        </div>
        <div className="bg-white rounded-lg shadow-md p-6">
          <div className="text-3xl font-bold text-teal-600">{totalFeedback}</div>
          <div className="text-gray-600">{t('stats.feedback')}</div>
        </div>
      </div>

      <div className="grid md:grid-cols-2 gap-6">
        <Link href="/admin/students" className="block bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition">
          <h2 className="text-xl font-semibold text-gray-800 mb-2">
            {t('quickActions.manageStudents')}
          </h2>
          <p className="text-gray-600">{t('quickActions.manageStudentsDesc')}</p>
        </Link>
      </div>
    </div>
  );
}
```

### Translation Keys Example
```json
// messages/en.json
{
  "admin": {
    "logout": "Logout",
    "nav": {
      "dashboard": "Dashboard",
      "students": "Students"
    },
    "dashboard": {
      "heading": "Admin Dashboard",
      "stats": {
        "students": "Total Students",
        "resources": "Total Resources",
        "feedback": "Feedback Posted"
      },
      "quickActions": {
        "manageStudents": "Manage Students",
        "manageStudentsDesc": "View all students, add new students, and manage their resources."
      }
    }
  }
}
```

### Testing
- **Instructor Login:** Log in with instructor credentials, verify `/admin` access
- **Student Login:** Log in as student, try accessing `/admin`, verify redirect to `/dashboard`
- **Role Check:** Verify middleware checks role metadata correctly
- **Admin Dashboard:** Verify stats display correctly
- **Logout:** Click logout button and verify redirect to homepage
- **Navigation:** Verify admin navigation links work

### Security Considerations
- Role must be stored in `publicMetadata` for middleware access
- Never store sensitive data in public metadata
- Instructor credentials should be securely managed (password manager)
- Consider 2FA for instructor account (Clerk supports)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | 1.0 | Initial story creation | John (PM Agent) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
