# Story 1.4: Prisma ORM Setup & Initial Schema

## Status
Ready for Review

## Dependencies
- ✅ **REQUIRED**: Story 1.3 (Railway Postgres Database) must be completed first
  - Needs `DATABASE_URL` environment variable configured

## Story
**As a** developer,
**I want** Prisma ORM installed with initial database schema including Student, Resource, and Feedback models,
**so that** I have type-safe database access and schema version control from the start.

## Acceptance Criteria
1. Prisma installed and initialized with PostgreSQL provider
2. Prisma schema defines `Student`, `Resource`, `Feedback` models
3. `Resource` model includes `fileData` as `Bytes` type for BYTEA storage
4. Appropriate indexes defined on foreign keys and frequently queried fields
5. Initial migration created and applied to Railway database
6. Prisma Client generated and importable in TypeScript with full type safety
7. Prisma Studio accessible locally for database inspection (`npx prisma studio`)
8. Database seed script created (optional sample data for development)

## Tasks / Subtasks
- [x] Install and initialize Prisma (AC: 1)
  - [x] Run `npm install prisma @prisma/client`
  - [x] Run `npx prisma init`
  - [x] Configure PostgreSQL provider in schema.prisma
  - [x] Update DATABASE_URL in .env
- [x] Define Student model (AC: 2)
  - [x] Create Student model with id, email, name, preferredLanguage
  - [x] Add timestamps (createdAt, updatedAt)
  - [x] Add unique constraint on email
- [x] Define Resource model (AC: 2, 3)
  - [x] Create Resource model with id, filename, mimeType, fileSize
  - [x] Add fileData field as Bytes type
  - [x] Add foreign key to Student (studentId)
  - [x] Add timestamps
- [x] Define Feedback model (AC: 2)
  - [x] Create Feedback model with id, content (text)
  - [x] Add foreign key to Student (studentId)
  - [x] Add timestamps
- [x] Add indexes (AC: 4)
  - [x] Index on Student.email
  - [x] Index on Resource.studentId
  - [x] Index on Feedback.studentId
- [x] Create and apply migration (AC: 5)
  - [x] Run `npx prisma migrate dev --name init`
  - [x] Verify migration applied to Railway database
  - [x] Check migration files created
- [x] Generate Prisma Client (AC: 6)
  - [x] Run `npx prisma generate`
  - [x] Verify type safety in VSCode
  - [x] Test import in TypeScript file
- [x] Verify Prisma Studio (AC: 7)
  - [x] Run `npx prisma studio`
  - [x] Open in browser and verify all models visible
- [x] Create seed script (AC: 8)
  - [x] Create prisma/seed.ts
  - [x] Add sample Student, Resource, Feedback data
  - [x] Add seed script to package.json
  - [x] Test seed execution

## Dev Notes

### Prisma Schema Structure

```prisma
// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Student {
  id                String     @id @default(cuid())
  email             String     @unique
  name              String
  preferredLanguage String     @default("en") // "en" or "fr"
  clerkUserId       String?    @unique // Reference to Clerk user
  resources         Resource[]
  feedback          Feedback[]
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  @@index([email])
}

model Resource {
  id        String   @id @default(cuid())
  filename  String
  mimeType  String
  fileSize  Int
  fileData  Bytes    // BYTEA storage for file content (max 50MB)
  studentId String
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId])
}

model Feedback {
  id        String   @id @default(cuid())
  content   String   @db.Text // Rich text/markdown content
  studentId String
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId])
}
```

### File Storage Strategy
- **BYTEA Storage:** Files stored as binary data in PostgreSQL
- **Size Limit:** 50MB per file (enforce in application logic)
- **Large Files:** Recommend YouTube/Vimeo URLs for videos instead of upload

### Prisma Commands Reference
- `npx prisma migrate dev` - Create and apply migrations in development
- `npx prisma generate` - Generate Prisma Client
- `npx prisma studio` - Open database GUI
- `npx prisma db seed` - Run seed script

### Testing
- **Schema Validation:** Run `npx prisma validate`
- **Migration Test:** Verify migration applied successfully to Railway
- **Type Safety:** Import PrismaClient and verify autocomplete works
- **Seed Test:** Run seed script and verify data in Prisma Studio

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | 1.0 | Initial story creation | John (PM Agent) |
| 2025-10-24 | 1.1 | Story implementation completed - all ACs met | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
No critical issues encountered. Removed auto-generated `prisma.config.ts` that was causing DATABASE_URL loading issues and used environment variable directly with Prisma CLI commands.

### Completion Notes List
- Prisma ORM successfully installed and configured with PostgreSQL provider
- All three database models (Student, Resource, Feedback) defined with proper relationships and indexes
- Initial migration `20251024172250_init` created and applied to Railway database
- Prisma Client generated with full TypeScript type safety
- Database seed script created with sample data for all models
- Prisma Studio verified accessible at localhost:5555
- Type safety validation successful (TypeScript compilation passes)

### File List
**Created:**
- `prisma/schema.prisma` - Prisma schema with Student, Resource, Feedback models
- `prisma/migrations/20251024172250_init/migration.sql` - Initial database migration
- `prisma/seed.ts` - Database seed script with sample data
- `app/lib/db.ts` - Prisma Client singleton instance
- `app/tests/prisma.test.ts` - Type safety validation tests

**Modified:**
- `.env.local` - Updated DATABASE_URL configuration for local development
- `package.json` - Added prisma seed configuration and tsx dependency

**Deleted:**
- `prisma.config.ts` - Removed auto-generated config that caused environment variable issues

## QA Results

### Review Date: 2025-10-24

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Grade: EXCELLENT** - Clean, well-structured Prisma ORM setup with proper PostgreSQL integration. All acceptance criteria met with high-quality implementation. Schema design follows best practices with appropriate indexes, cascade deletes, and type safety.

### Refactoring Performed

- **File**: `app/lib/db.ts`
  - **Change**: Added environment-aware logging configuration
  - **Why**: Production environments should not log all queries (performance and log volume concerns)
  - **How**: Changed from `log: ["query", "error", "warn"]` to conditional logging - full logging in development, errors only in production (line 8)

- **File**: `prisma/seed.ts`
  - **Change**: Added idempotent seed script with data cleanup
  - **Why**: Re-running seed script would fail on unique constraint violations (email uniqueness)
  - **How**: Added conditional cleanup of existing seed data before insertion (lines 9-14) - only runs in non-production environments

### Compliance Check

- ✅ **Coding Standards**: Full compliance with `docs/architecture/coding-standards.md`
  - Prisma singleton pattern correctly implemented
  - Environment variables accessed via Prisma configuration
  - camelCase naming for database columns

- ✅ **Project Structure**: Correct file organization per BMAD structure
  - Schema in `prisma/schema.prisma`
  - Seed in `prisma/seed.ts`
  - Client singleton in `app/lib/db.ts`
  - Tests in `app/tests/prisma.test.ts`

- ✅ **Testing Strategy**: Type safety validation present (compile-time checks)

- ✅ **All ACs Met**: 8/8 acceptance criteria fully implemented

### Improvements Checklist

**Completed by QA:**
- [x] Refactored db.ts for environment-aware logging (app/lib/db.ts:8)
- [x] Made seed script idempotent with cleanup logic (prisma/seed.ts:9-14)

**Recommended for Future Stories:**
- [ ] Add integration tests for database operations (test actual CRUD operations against test database)
- [ ] Add automated seed validation tests (verify seed script creates expected records)
- [ ] Add migration rollback tests (verify schema can be rolled back safely)
- [ ] Consider adding database query performance benchmarks for BYTEA operations

### Security Review

✅ **PASS** - No security concerns identified:
- Database credentials properly secured via environment variables
- No secrets committed to repository
- Cascade deletes prevent orphaned records
- Unique constraints on sensitive fields (email, clerkUserId)

### Performance Considerations

✅ **PASS** - Optimized for expected workload:
- Appropriate indexes on foreign keys and frequently queried fields
- BYTEA storage suitable for 50MB file limit (NFR5 compliant)
- Query logging disabled in production to reduce overhead

**Note**: File size validation (50MB limit) deferred to application layer per dev notes - ensure this is enforced in future API route handlers.

### Files Modified During Review

**Modified by QA:**
- `app/lib/db.ts` - Added environment-aware logging
- `prisma/seed.ts` - Added idempotent cleanup logic

**Developer Action**: Please update the "File List" section in "Dev Agent Record" to include these QA modifications.

### Gate Status

**Gate**: PASS → `docs/qa/gates/1.4-prisma-orm-setup.yml`

**Gate Decision Rationale**: All acceptance criteria met, standards compliant, NFRs validated, with minor test coverage recommendations for future work. Refactoring improvements applied during review.

### Recommended Status

✅ **Ready for Done** - Story fully complete with QA improvements applied. Minor test recommendations are non-blocking and should be addressed in future stories (Epic 1 testing story or during feature development).
