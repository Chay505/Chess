# Story 3.3: Display Student Resources

## Status
Ready for Review

## Dependencies
- ‚úÖ **REQUIRED**: Story 3.2 (Student Dashboard Layout) must be completed first
  - Needs ResourcesList component placeholder
- ‚úÖ **REQUIRED**: Story 1.4 (Prisma ORM) for database queries
- ‚úÖ **REQUIRED**: Story 3.1 (Clerk Auth) for user authorization

## Story
**As a** student,
**I want** list of files the instructor uploaded for me with download links,
**so that** I can access PGN files, PDFs, and other coaching materials.

## Acceptance Criteria
1. "My Resources" section queries database for files associated with logged-in student
2. Files displayed in list or card format with filename, file type, upload date
3. Each file has "Download" button that triggers file download
4. Downloads served via API route (`/api/resources/[id]`) with authentication check
5. Only student's own files accessible (authorization check)
6. Files sorted by upload date (newest first)
7. Empty state: "No resources yet. Your instructor will upload materials here."

## Tasks / Subtasks
- [x] Create Prisma query for student resources (AC: 1)
  - [x] Query `Resource` table filtered by `studentId`
  - [x] Get student ID from Clerk user metadata or Student table
  - [x] Include fields: id, filename, mimeType, fileSize, createdAt
  - [x] Sort by `createdAt` DESC (newest first)
- [x] Update ResourcesList component (AC: 2, 6)
  - [x] Fetch resources data on component mount
  - [x] Display each resource in card format
  - [x] Show: Filename, file type icon, upload date, file size
  - [x] Handle loading state while fetching
  - [x] Handle error state if fetch fails
- [x] Add download button (AC: 3)
  - [x] Create "Download" button for each resource
  - [x] On click, call `/api/resources/[id]` endpoint
  - [x] Trigger browser download with correct filename
  - [x] Show loading indicator during download
- [x] Create file download API route (AC: 4, 5)
  - [x] Create `/app/api/resources/[id]/route.ts`
  - [x] Verify Clerk authentication (check `userId`)
  - [x] Query resource by ID from database
  - [x] Verify resource belongs to authenticated student (authorization)
  - [x] Return 403 if user doesn't own resource
  - [x] Serve file data with correct MIME type and filename
  - [x] Set Content-Disposition header for download
- [x] Implement empty state (AC: 7)
  - [x] Check if resources array is empty
  - [x] Display empty state message and illustration
  - [x] Keep empty state from Story 3.2 if no resources
- [x] Test authorization (AC: 5)
  - [x] Create test resources for different students
  - [x] Try accessing another student's resource URL
  - [x] Verify 403 error returned

## Dev Notes

### Component Specifications
- **Resources List Component:** `/components/dashboard/ResourcesList.tsx`
- **API Route:** `/app/api/resources/[id]/route.ts`
- **Database Query:** Prisma query on `Resource` model

### Design Details from Front-End Spec
**Resource Card Layout:**
- Card with file icon, filename, metadata, download button
- File icon: PDF (üìÑ), PGN (‚ôüÔ∏è), Image (üñºÔ∏è), etc.
- Metadata: File size, upload date
- Download button: Primary button style

**Card Design:**
- Border: Light gray (#E5E7EB)
- Padding: 16px
- Border-radius: 8px
- Hover: Slight shadow elevation

**Typography:**
- Filename: 16px, weight 600
- Metadata: 14px, weight 400, gray color

### Prisma Schema Reference (from Story 1.4)
```prisma
model Resource {
  id        String   @id @default(cuid())
  filename  String
  mimeType  String
  fileSize  Int
  fileData  Bytes    // BYTEA storage
  studentId String
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId])
}
```

### Example Code Structure
```tsx
// components/dashboard/ResourcesList.tsx
'use client';
import { useState, useEffect } from 'react';
import { useUser } from '@clerk/nextjs';
import { useTranslations } from 'next-intl';
import { ArrowDownTrayIcon, DocumentIcon } from '@heroicons/react/24/outline';

interface Resource {
  id: string;
  filename: string;
  mimeType: string;
  fileSize: number;
  createdAt: string;
}

export default function ResourcesList() {
  const { user } = useUser();
  const t = useTranslations('dashboard.resources');
  const [resources, setResources] = useState<Resource[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchResources();
  }, [user]);

  const fetchResources = async () => {
    try {
      const res = await fetch('/api/resources');
      const data = await res.json();
      setResources(data.resources || []);
    } catch (error) {
      console.error('Failed to fetch resources:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleDownload = async (id: string, filename: string) => {
    try {
      const res = await fetch(`/api/resources/${id}`);
      if (res.ok) {
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      } else {
        alert(t('downloadError'));
      }
    } catch (error) {
      console.error('Download failed:', error);
      alert(t('downloadError'));
    }
  };

  if (loading) {
    return <div className="text-center py-12">{t('loading')}</div>;
  }

  if (resources.length === 0) {
    return (
      <div className="text-center py-12 text-gray-500">
        {t('emptyState')}
      </div>
    );
  }

  return (
    <div className="space-y-4">
      {resources.map((resource) => (
        <div
          key={resource.id}
          className="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:shadow-md transition"
        >
          <div className="flex items-center space-x-4">
            <DocumentIcon className="w-8 h-8 text-teal-600" />
            <div>
              <div className="font-semibold text-gray-800">
                {resource.filename}
              </div>
              <div className="text-sm text-gray-500">
                {(resource.fileSize / 1024 / 1024).toFixed(2)} MB ‚Ä¢ {new Date(resource.createdAt).toLocaleDateString()}
              </div>
            </div>
          </div>
          <button
            onClick={() => handleDownload(resource.id, resource.filename)}
            className="flex items-center space-x-2 bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition"
          >
            <ArrowDownTrayIcon className="w-5 h-5" />
            <span>{t('download')}</span>
          </button>
        </div>
      ))}
    </div>
  );
}
```

```ts
// app/api/resources/route.ts
import { auth } from '@clerk/nextjs';
import { NextResponse } from 'next/server';
import prisma from '@/lib/prisma';

export async function GET() {
  try {
    const { userId } = auth();

    if (!userId) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    // Find student by clerkUserId
    const student = await prisma.student.findUnique({
      where: { clerkUserId: userId }
    });

    if (!student) {
      return NextResponse.json({ error: 'Student not found' }, { status: 404 });
    }

    // Fetch resources for this student
    const resources = await prisma.resource.findMany({
      where: { studentId: student.id },
      select: {
        id: true,
        filename: true,
        mimeType: true,
        fileSize: true,
        createdAt: true
      },
      orderBy: { createdAt: 'desc' }
    });

    return NextResponse.json({ resources });
  } catch (error) {
    console.error('Error fetching resources:', error);
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });
  }
}
```

```ts
// app/api/resources/[id]/route.ts
import { auth } from '@clerk/nextjs';
import { NextResponse } from 'next/server';
import prisma from '@/lib/prisma';

export async function GET(
  request: Request,
  { params }: { params: { id: string } }
) {
  try {
    const { userId } = auth();

    if (!userId) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    // Find student by clerkUserId
    const student = await prisma.student.findUnique({
      where: { clerkUserId: userId }
    });

    if (!student) {
      return NextResponse.json({ error: 'Student not found' }, { status: 404 });
    }

    // Fetch resource and verify ownership
    const resource = await prisma.resource.findUnique({
      where: { id: params.id }
    });

    if (!resource) {
      return NextResponse.json({ error: 'Resource not found' }, { status: 404 });
    }

    if (resource.studentId !== student.id) {
      return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
    }

    // Serve file with correct headers
    return new NextResponse(resource.fileData, {
      headers: {
        'Content-Type': resource.mimeType,
        'Content-Disposition': `attachment; filename="${resource.filename}"`,
        'Content-Length': resource.fileSize.toString()
      }
    });
  } catch (error) {
    console.error('Error downloading resource:', error);
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });
  }
}
```

### Translation Keys Example
```json
// messages/en.json
{
  "dashboard": {
    "resources": {
      "loading": "Loading resources...",
      "download": "Download",
      "downloadError": "Failed to download file. Please try again.",
      "emptyState": "No resources yet. Your instructor will upload materials here."
    }
  }
}
```

### Testing
- **List Display:** Log in and verify resources list displays correctly
- **Download:** Click download button and verify file downloads
- **Authorization:** Try accessing another student's resource URL directly (should return 403)
- **Empty State:** Verify empty state displays when no resources
- **File Types:** Test with different file types (PDF, PGN, images)
- **File Size Display:** Verify file size displays correctly (MB)
- **Date Format:** Verify upload date displays in user's locale
- **Loading State:** Verify loading indicator shows while fetching

### Edge Cases
- Large files (close to 50MB): Verify download works
- Slow network: Test with throttled connection
- Corrupted file data: Handle gracefully
- Missing MIME type: Set default to application/octet-stream

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | 1.0 | Initial story creation | John (PM Agent) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
None required

### Completion Notes List
- Implemented full resources list and download functionality
- API routes include proper authentication and authorization checks
- Component handles loading, empty, and error states
- All tests passing (11 total: 9 API tests, 2 component tests)
- Translation keys added for EN and FR
- Download functionality includes downloading state indicator

### File List
**Created:**
- `/app/api/resources/route.ts` - List resources API endpoint
- `/app/api/resources/[id]/route.ts` - Download resource API endpoint
- `/app/tests/api/resources.test.ts` - API route tests

**Modified:**
- `/app/components/dashboard/ResourcesList.tsx` - Implemented full functionality
- `/app/tests/components/ResourcesList.test.tsx` - Updated component tests
- `/messages/en.json` - Added resource translation keys
- `/messages/fr.json` - Added resource translation keys

## QA Results
_To be populated by QA agent_
