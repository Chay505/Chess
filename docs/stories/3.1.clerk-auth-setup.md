# Story 3.1: Clerk Authentication Setup

## Status
Draft

## Story
**As a** developer,
**I want** Clerk authentication integrated with sign-up and login flows,
**so that** students can create accounts and access their personal portal securely.

## Acceptance Criteria
1. Clerk account created and application configured
2. Clerk API keys added to environment variables
3. Clerk middleware configured to protect `/dashboard/*` routes
4. Sign-up page created at `/sign-up` with email/password
5. Login page created at `/login`
6. After login, users redirected to `/dashboard`
7. Unauthenticated users redirected to login when accessing protected routes
8. Clerk User Management dashboard accessible for manual user administration

## Tasks / Subtasks
- [ ] Create Clerk account and application (AC: 1)
  - [ ] Sign up for Clerk account (Free tier)
  - [ ] Create new application: "Chess Coaching Platform"
  - [ ] Note application ID and API keys
  - [ ] Configure authentication methods (email/password)
  - [ ] Disable social login for MVP (optional for future)
- [ ] Configure environment variables (AC: 2)
  - [ ] Add `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY` to `.env.local`
  - [ ] Add `CLERK_SECRET_KEY` to `.env.local`
  - [ ] Add keys to Vercel environment variables
  - [ ] Update `.env.example` with placeholder values
- [ ] Install Clerk SDK (AC: 3)
  - [ ] Run `npm install @clerk/nextjs`
  - [ ] Wrap app with `<ClerkProvider>` in root layout
  - [ ] Create middleware.ts to protect routes
  - [ ] Configure middleware to protect `/dashboard/*` routes
- [ ] Create sign-up page (AC: 4)
  - [ ] Create `/app/[locale]/sign-up/page.tsx`
  - [ ] Use Clerk `<SignUp />` component
  - [ ] Style to match brand (customize appearance)
  - [ ] Add bilingual support for form labels
  - [ ] Set redirect URL to `/dashboard` after signup
- [ ] Create login page (AC: 5)
  - [ ] Create `/app/[locale]/login/page.tsx`
  - [ ] Use Clerk `<SignIn />` component
  - [ ] Style to match brand
  - [ ] Add bilingual support
  - [ ] Set redirect URL to `/dashboard` after login
- [ ] Configure redirects (AC: 6, 7)
  - [ ] Set `afterSignIn` redirect to `/dashboard`
  - [ ] Set `afterSignUp` redirect to `/dashboard`
  - [ ] Configure middleware to redirect unauthenticated users to `/login`
  - [ ] Test protected route access without authentication
- [ ] Test Clerk User Management (AC: 8)
  - [ ] Access Clerk dashboard
  - [ ] Verify users list is visible
  - [ ] Test manual user creation
  - [ ] Test user role assignment (student vs. instructor)

## Dev Notes

### Component Specifications
- **Clerk SDK:** `@clerk/nextjs`
- **Sign-up Page:** `/app/[locale]/sign-up/page.tsx`
- **Login Page:** `/app/[locale]/login/page.tsx`
- **Middleware:** `/middleware.ts`
- **Protected Routes:** `/dashboard/*`, `/admin/*`

### Clerk Configuration
**Authentication Methods:**
- Email/password (enabled)
- Email verification (enabled)
- Social login (disabled for MVP)

**User Metadata:**
- Add custom field: `role` (values: "student" or "instructor")
- Add custom field: `preferredLanguage` (values: "en" or "fr")

**Appearance Customization:**
- Primary color: `#4A9B8E` (teal)
- Font family: Inter
- Logo: Chess coaching logo (upload to Clerk)

### Example Code Structure
```tsx
// app/layout.tsx
import { ClerkProvider } from '@clerk/nextjs';

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <ClerkProvider>
      <html>
        <body>{children}</body>
      </html>
    </ClerkProvider>
  );
}
```

```ts
// middleware.ts
import { authMiddleware } from '@clerk/nextjs';

export default authMiddleware({
  publicRoutes: ['/', '/en', '/fr', '/en/(.*)', '/fr/(.*)', '/api/(.*)'],
  ignoredRoutes: ['/api/webhook']
});

export const config = {
  matcher: ['/((?!.+\\.[\\w]+$|_next).*)', '/', '/(api|trpc)(.*)']
};
```

```tsx
// app/[locale]/sign-up/page.tsx
import { SignUp } from '@clerk/nextjs';

export default function SignUpPage() {
  return (
    <div className="flex min-h-screen items-center justify-center bg-gray-50">
      <SignUp
        appearance={{
          elements: {
            rootBox: 'mx-auto',
            card: 'shadow-lg'
          },
          variables: {
            colorPrimary: '#4A9B8E'
          }
        }}
        redirectUrl="/dashboard"
      />
    </div>
  );
}
```

```tsx
// app/[locale]/login/page.tsx
import { SignIn } from '@clerk/nextjs';

export default function LoginPage() {
  return (
    <div className="flex min-h-screen items-center justify-center bg-gray-50">
      <SignIn
        appearance={{
          elements: {
            rootBox: 'mx-auto',
            card: 'shadow-lg'
          },
          variables: {
            colorPrimary: '#4A9B8E'
          }
        }}
        redirectUrl="/dashboard"
      />
    </div>
  );
}
```

### Environment Variables
```
# .env.local
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...

# .env.example
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=your_clerk_publishable_key
CLERK_SECRET_KEY=your_clerk_secret_key
```

### Clerk Dashboard Configuration
**Settings:**
- Application name: "Chess Coaching Platform"
- Home URL: `https://yourwebsite.com`
- Sign-in URL: `https://yourwebsite.com/login`
- Sign-up URL: `https://yourwebsite.com/sign-up`
- After sign-in URL: `https://yourwebsite.com/dashboard`
- After sign-up URL: `https://yourwebsite.com/dashboard`

**User & Roles:**
- Create custom user metadata field: `role` (string: "student" or "instructor")
- Create custom user metadata field: `preferredLanguage` (string: "en" or "fr")

### Testing
- **Sign-up Flow:** Create new user account via sign-up page
- **Login Flow:** Log in with existing credentials
- **Email Verification:** Verify email verification email is sent
- **Protected Routes:** Try accessing `/dashboard` without authentication, verify redirect to `/login`
- **Logout:** Test logout functionality
- **User Management:** Access Clerk dashboard, verify user appears in users list
- **Appearance:** Verify Clerk components match brand colors

### Clerk Documentation
- Quickstart: https://clerk.com/docs/quickstarts/nextjs
- Middleware: https://clerk.com/docs/references/nextjs/auth-middleware
- Appearance: https://clerk.com/docs/components/customization/overview

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | 1.0 | Initial story creation | John (PM Agent) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
