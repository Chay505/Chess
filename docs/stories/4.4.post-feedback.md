# Story 4.4: Post Feedback for Specific Student

## Status
Draft

## Story
**As the** instructor,
**I want** simple text editor to post lesson feedback for students,
**so that** I can share post-lesson analysis and improvement recommendations.

## Acceptance Criteria
1. Student detail page includes "Post Feedback" section with text editor
2. Text editor supports basic formatting (bold, italic, lists, links) or markdown
3. "Post Feedback" button submits feedback to database via API route
4. Feedback associated with specific student and timestamped
5. Posted feedback appears in student's portal immediately
6. Admin page shows previously posted feedback with "Edit" and "Delete" options
7. Feedback form includes character count (optional length limit)

## Tasks / Subtasks
- [ ] Add feedback section to student detail page (AC: 1)
  - [ ] Add "Post Feedback" section below "Uploaded Files" section
  - [ ] Create text editor component (textarea or rich text editor)
  - [ ] Add formatting toolbar if using rich text editor
  - [ ] Add "Post Feedback" button
- [ ] Implement text editor with formatting (AC: 2)
  - [ ] Option 1: Simple textarea with markdown support
  - [ ] Option 2: Rich text editor (e.g., Tiptap, react-quill)
  - [ ] Support bold, italic, lists, links
  - [ ] Display formatting preview (optional)
- [ ] Create feedback submission API route (AC: 3, 4)
  - [ ] Create `/app/api/admin/feedback/route.ts`
  - [ ] Verify user has instructor role
  - [ ] Receive feedback content and studentId
  - [ ] Create `Feedback` record in database with timestamp
  - [ ] Return success response
- [ ] Display posted feedback list (AC: 5, 6)
  - [ ] Query all feedback for student from database
  - [ ] Display in chronological order (newest first)
  - [ ] Show: Date posted, feedback content
  - [ ] Add "Edit" and "Delete" buttons for each feedback
  - [ ] Implement delete functionality with confirmation
- [ ] Add character count (AC: 7)
  - [ ] Display character count below editor
  - [ ] Optional: Set max length (e.g., 5000 characters)
  - [ ] Show warning at 80% of limit
- [ ] Test feedback posting
  - [ ] Post feedback with plain text
  - [ ] Post feedback with markdown formatting
  - [ ] Verify feedback appears in student portal immediately
  - [ ] Test edit functionality (optional for MVP)
  - [ ] Test delete functionality

## Dev Notes

### Component Specifications
- **Feedback Section:** Add to `/app/[locale]/admin/students/[id]/page.tsx`
- **Feedback Editor:** `/components/admin/FeedbackEditor.tsx`
- **Feedback List:** `/components/admin/FeedbackList.tsx`
- **API Route:** `/app/api/admin/feedback/route.ts`

### Design Details from Front-End Spec
**Feedback Section Layout:**
- Section heading: "Post Feedback"
- Text editor with formatting toolbar (if rich text)
- Character count indicator
- "Post Feedback" button
- List of previously posted feedback below

**Editor Design:**
- Textarea or rich text editor
- Min height: 150px
- Border: Light gray (#E5E7EB)
- Focus: Teal ring (#4A9B8E)

**Posted Feedback Display:**
- Cards with date and content
- Edit/Delete buttons (small, subtle)
- Delete confirmation dialog

**Typography:**
- Section heading: H2, 24px, weight 600
- Editor text: 16px, weight 400, line-height 1.6
- Character count: 14px, weight 400, gray

### Text Editor Options
**Option 1: Simple Textarea (Markdown)**
- Use `<textarea>` for input
- Store content as markdown
- Render with `react-markdown` in student portal
- Pros: Simple, no dependencies
- Cons: No WYSIWYG preview

**Option 2: Rich Text Editor**
- Use Tiptap or react-quill
- WYSIWYG editing
- Pros: User-friendly, visual feedback
- Cons: Additional dependency, larger bundle

### Example Code Structure
```tsx
// components/admin/FeedbackEditor.tsx
'use client';
import { useState } from 'react';
import { useTranslations } from 'next-intl';

export default function FeedbackEditor({ studentId }: { studentId: string }) {
  const t = useTranslations('admin.feedback');
  const [content, setContent] = useState('');
  const [submitting, setSubmitting] = useState(false);
  const [error, setError] = useState('');

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!content.trim()) {
      setError(t('errorEmpty'));
      return;
    }

    setSubmitting(true);
    setError('');

    try {
      const res = await fetch('/api/admin/feedback', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ studentId, content })
      });

      if (res.ok) {
        setContent('');
        alert(t('successMessage'));
        window.location.reload(); // Refresh to show new feedback
      } else {
        const data = await res.json();
        setError(data.error || t('errorSubmit'));
      }
    } catch (err) {
      setError(t('errorSubmit'));
    } finally {
      setSubmitting(false);
    }
  };

  return (
    <form onSubmit={handleSubmit}>
      <div className="mb-4">
        <textarea
          value={content}
          onChange={(e) => setContent(e.target.value)}
          placeholder={t('placeholder')}
          rows={6}
          className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
        />
        <div className="flex justify-between items-center mt-2">
          <div className="text-sm text-gray-500">
            {content.length} {t('characters')}
            {content.length > 5000 && (
              <span className="text-red-600 ml-2">{t('warningLength')}</span>
            )}
          </div>
          <div className="text-xs text-gray-400">
            {t('markdownSupport')}
          </div>
        </div>
      </div>

      {error && (
        <div className="mb-4 p-3 bg-red-50 border border-red-200 text-red-800 rounded-lg text-sm">
          {error}
        </div>
      )}

      <button
        type="submit"
        disabled={submitting || !content.trim()}
        className="bg-teal-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-teal-700 transition disabled:opacity-50"
      >
        {submitting ? t('posting') : t('postFeedback')}
      </button>
    </form>
  );
}
```

```tsx
// components/admin/FeedbackList.tsx
'use client';
import { useState } from 'react';
import { useTranslations } from 'next-intl';
import ReactMarkdown from 'react-markdown';

interface Feedback {
  id: string;
  content: string;
  createdAt: string;
}

export default function FeedbackList({
  initialFeedback,
  studentId
}: {
  initialFeedback: Feedback[];
  studentId: string;
}) {
  const t = useTranslations('admin.feedback');
  const [feedback, setFeedback] = useState(initialFeedback);

  const handleDelete = async (id: string) => {
    if (!confirm(t('confirmDelete'))) return;

    try {
      const res = await fetch(`/api/admin/feedback/${id}`, {
        method: 'DELETE'
      });

      if (res.ok) {
        setFeedback(feedback.filter((f) => f.id !== id));
        alert(t('deleteSuccess'));
      } else {
        alert(t('deleteError'));
      }
    } catch (err) {
      alert(t('deleteError'));
    }
  };

  if (feedback.length === 0) {
    return (
      <div className="text-center py-8 text-gray-500">
        {t('noFeedback')}
      </div>
    );
  }

  return (
    <div className="space-y-4">
      {feedback.map((item) => (
        <div
          key={item.id}
          className="bg-gray-50 border border-gray-200 rounded-lg p-5"
        >
          <div className="flex justify-between items-start mb-3">
            <div className="text-sm font-semibold text-gray-500">
              {new Date(item.createdAt).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
              })}
            </div>
            <button
              onClick={() => handleDelete(item.id)}
              className="text-sm text-red-600 hover:text-red-800"
            >
              {t('delete')}
            </button>
          </div>
          <div className="prose prose-sm max-w-none text-gray-700">
            <ReactMarkdown>{item.content}</ReactMarkdown>
          </div>
        </div>
      ))}
    </div>
  );
}
```

```ts
// app/api/admin/feedback/route.ts
import { auth } from '@clerk/nextjs';
import { NextResponse } from 'next/server';
import prisma from '@/lib/prisma';

export async function POST(request: Request) {
  try {
    const { userId, sessionClaims } = auth();

    if (!userId || sessionClaims?.metadata?.role !== 'instructor') {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 403 });
    }

    const { studentId, content } = await request.json();

    if (!studentId || !content) {
      return NextResponse.json({ error: 'Missing required fields' }, { status: 400 });
    }

    const feedback = await prisma.feedback.create({
      data: {
        studentId,
        content
      }
    });

    return NextResponse.json({ feedback });
  } catch (error) {
    console.error('Error posting feedback:', error);
    return NextResponse.json({ error: 'Failed to post feedback' }, { status: 500 });
  }
}
```

```ts
// app/api/admin/feedback/[id]/route.ts
import { auth } from '@clerk/nextjs';
import { NextResponse } from 'next/server';
import prisma from '@/lib/prisma';

export async function DELETE(
  request: Request,
  { params }: { params: { id: string } }
) {
  try {
    const { userId, sessionClaims } = auth();

    if (!userId || sessionClaims?.metadata?.role !== 'instructor') {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 403 });
    }

    await prisma.feedback.delete({
      where: { id: params.id }
    });

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error('Error deleting feedback:', error);
    return NextResponse.json({ error: 'Failed to delete feedback' }, { status: 500 });
  }
}
```

### Translation Keys Example
```json
// messages/en.json
{
  "admin": {
    "feedback": {
      "placeholder": "Write your feedback here. You can use markdown for formatting (e.g., **bold**, *italic*, lists).",
      "characters": "characters",
      "warningLength": "Consider keeping feedback under 5000 characters",
      "markdownSupport": "Markdown supported",
      "postFeedback": "Post Feedback",
      "posting": "Posting...",
      "successMessage": "Feedback posted successfully!",
      "errorEmpty": "Feedback cannot be empty",
      "errorSubmit": "Failed to post feedback. Please try again.",
      "noFeedback": "No feedback posted yet",
      "delete": "Delete",
      "confirmDelete": "Are you sure you want to delete this feedback? The student will no longer see it.",
      "deleteSuccess": "Feedback deleted successfully",
      "deleteError": "Failed to delete feedback"
    }
  }
}
```

### Markdown Formatting Guide (for Instructor)
- **Bold:** `**text**`
- *Italic:* `*text*`
- Lists: `- item` or `1. item`
- Links: `[text](url)`
- Headings: `## Heading`

### Testing
- **Post Feedback:** Write feedback with markdown, submit, verify success
- **Character Count:** Type text and verify character count updates
- **Student Portal:** Verify feedback appears in student portal immediately
- **Markdown Rendering:** Verify markdown formats correctly in student view
- **Delete:** Delete feedback, confirm dialog, verify deletion
- **Long Feedback:** Test with 5000+ characters, verify warning
- **Empty Submission:** Try submitting empty feedback, verify error

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | 1.0 | Initial story creation | John (PM Agent) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
