# Story 4.3: Upload Resources for Specific Student

## Status
Draft

## Dependencies
- ✅ **REQUIRED**: Story 4.2 (Student List) must be completed first
  - Needs student detail page route `/admin/students/[id]`
- ✅ **REQUIRED**: Story 1.4 (Prisma ORM) for Resource model and BYTEA storage

## Story
**As the** instructor,
**I want** file upload interface for each student,
**so that** I can share PGN files, PDFs, and coaching materials with individual students.

## Acceptance Criteria
1. Student detail page at `/admin/students/[id]` shows student info and upload section
2. File upload form accepts files up to 50MB
3. Supported file types: PDF, PGN, TXT, DOCX, images (PNG, JPG)
4. Upload button triggers API route that stores file as BYTEA in PostgreSQL
5. File metadata stored: filename, mimeType, fileSize, uploadedAt
6. After upload, file appears in student's resource list immediately
7. Uploaded files listed on admin page with "Delete" option
8. Upload progress indicator shown during file processing

## Tasks / Subtasks
- [ ] Create student detail page (AC: 1)
  - [ ] Create `/app/[locale]/admin/students/[id]/page.tsx`
  - [ ] Fetch student data by ID from database
  - [ ] Display student info card: Name, Email, Preferred Language, Date Added
  - [ ] Add two sections: "Upload Resources" and "Uploaded Files"
- [ ] Create file upload form (AC: 2, 3)
  - [ ] Add file input field with drag-and-drop support
  - [ ] Validate file size (max 50MB) on client side
  - [ ] Validate file type (PDF, PGN, TXT, DOCX, PNG, JPG)
  - [ ] Display file preview before upload (filename, size)
  - [ ] Add "Upload" button
- [ ] Implement upload API route (AC: 4, 5)
  - [ ] Create `/app/api/admin/upload/route.ts`
  - [ ] Verify user has instructor role
  - [ ] Receive file and metadata from FormData
  - [ ] Convert file to Buffer (for BYTEA storage)
  - [ ] Create `Resource` record in database with file data
  - [ ] Associate resource with student ID
  - [ ] Return success response
- [ ] Show upload progress (AC: 8)
  - [ ] Display progress bar during file upload
  - [ ] Show percentage or spinner
  - [ ] Disable form during upload
  - [ ] Show success message after upload
- [ ] Display uploaded files list (AC: 6, 7)
  - [ ] Query student's resources from database
  - [ ] Display in table: Filename, Type, Size, Upload Date, Actions
  - [ ] Add "Delete" button for each file
  - [ ] Implement delete functionality with confirmation dialog
- [ ] Test file upload and storage
  - [ ] Upload various file types (PDF, PGN, PNG)
  - [ ] Verify file stored as BYTEA in database
  - [ ] Verify file appears in student portal immediately
  - [ ] Test file size limit (50MB)

## Dev Notes

### Component Specifications
- **Student Detail Page:** `/app/[locale]/admin/students/[id]/page.tsx`
- **Upload Form Component:** `/components/admin/ResourceUpload.tsx`
- **Upload API Route:** `/app/api/admin/upload/route.ts`
- **Delete API Route:** `/app/api/admin/resources/[id]/route.ts`

### Design Details from Front-End Spec
**Student Detail Page Layout:**
- Breadcrumbs: Admin > Students > [Student Name]
- Student info card at top
- Two main sections: "Upload Resources" and "Uploaded Files"

**Upload Section:**
- Drag-and-drop zone: "Drag files here or click to browse"
- File type guidance: "Supported: PDF, PGN, TXT, DOCX, PNG, JPG (Max 50MB)"
- File preview before upload (filename, size)
- Upload button with progress bar

**Uploaded Files List:**
- Table: Filename, Type, Size, Upload Date, Delete button
- Delete confirmation dialog: "Are you sure? Students will lose access to this file."

**Typography:**
- Page heading: H1, 32px, weight 600
- Section headings: H2, 24px, weight 600
- Table text: 16px, weight 400

### File Upload with FormData
```tsx
// Client-side upload
const handleUpload = async (file: File, studentId: string) => {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('studentId', studentId);

  const res = await fetch('/api/admin/upload', {
    method: 'POST',
    body: formData
  });

  return res.json();
};
```

### Example Code Structure
```tsx
// app/[locale]/admin/students/[id]/page.tsx
import { auth } from '@clerk/nextjs';
import { notFound } from 'next/navigation';
import prisma from '@/lib/prisma';
import ResourceUpload from '@/components/admin/ResourceUpload';
import UploadedFilesList from '@/components/admin/UploadedFilesList';

export default async function StudentDetailPage({
  params
}: {
  params: { id: string };
}) {
  const { userId, sessionClaims } = auth();

  if (!userId || sessionClaims?.metadata?.role !== 'instructor') {
    notFound();
  }

  const student = await prisma.student.findUnique({
    where: { id: params.id },
    include: {
      resources: {
        orderBy: { createdAt: 'desc' }
      }
    }
  });

  if (!student) {
    notFound();
  }

  return (
    <div>
      <nav className="text-sm text-gray-600 mb-6">
        Admin &gt; Students &gt; {student.name}
      </nav>

      <div className="bg-white rounded-lg shadow-md p-6 mb-8">
        <h1 className="text-3xl font-semibold text-gray-800 mb-4">
          {student.name}
        </h1>
        <div className="grid md:grid-cols-2 gap-4 text-gray-600">
          <div>
            <span className="font-medium">Email:</span> {student.email}
          </div>
          <div>
            <span className="font-medium">Preferred Language:</span>{' '}
            {student.preferredLanguage === 'en' ? 'English' : 'Français'}
          </div>
          <div>
            <span className="font-medium">Date Added:</span>{' '}
            {new Date(student.createdAt).toLocaleDateString()}
          </div>
        </div>
      </div>

      <div className="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 className="text-2xl font-semibold text-gray-800 mb-6">
          Upload Resources
        </h2>
        <ResourceUpload studentId={student.id} />
      </div>

      <div className="bg-white rounded-lg shadow-md p-6">
        <h2 className="text-2xl font-semibold text-gray-800 mb-6">
          Uploaded Files
        </h2>
        <UploadedFilesList initialResources={student.resources} studentId={student.id} />
      </div>
    </div>
  );
}
```

```tsx
// components/admin/ResourceUpload.tsx
'use client';
import { useState } from 'react';
import { useTranslations } from 'next-intl';
import { CloudArrowUpIcon } from '@heroicons/react/24/outline';

export default function ResourceUpload({ studentId }: { studentId: string }) {
  const t = useTranslations('admin.upload');
  const [file, setFile] = useState<File | null>(null);
  const [uploading, setUploading] = useState(false);
  const [progress, setProgress] = useState(0);
  const [error, setError] = useState('');

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const selectedFile = e.target.files?.[0];
    if (!selectedFile) return;

    // Validate file size (50MB)
    if (selectedFile.size > 50 * 1024 * 1024) {
      setError(t('errorFileSize'));
      return;
    }

    // Validate file type
    const allowedTypes = [
      'application/pdf',
      'text/plain',
      'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
      'image/png',
      'image/jpeg',
      'application/x-chess-pgn'
    ];

    if (!allowedTypes.includes(selectedFile.type) && !selectedFile.name.endsWith('.pgn')) {
      setError(t('errorFileType'));
      return;
    }

    setFile(selectedFile);
    setError('');
  };

  const handleUpload = async () => {
    if (!file) return;

    setUploading(true);
    setProgress(0);
    setError('');

    try {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('studentId', studentId);

      const res = await fetch('/api/admin/upload', {
        method: 'POST',
        body: formData
      });

      if (res.ok) {
        setFile(null);
        setProgress(100);
        alert(t('successMessage'));
        window.location.reload(); // Refresh to show new file
      } else {
        const data = await res.json();
        setError(data.error || t('errorUpload'));
      }
    } catch (err) {
      setError(t('errorUpload'));
    } finally {
      setUploading(false);
    }
  };

  return (
    <div>
      <div className="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
        <CloudArrowUpIcon className="w-16 h-16 mx-auto text-gray-400 mb-4" />
        <p className="text-gray-600 mb-2">{t('dragDrop')}</p>
        <p className="text-sm text-gray-500 mb-4">{t('supportedTypes')}</p>

        <input
          type="file"
          onChange={handleFileChange}
          accept=".pdf,.pgn,.txt,.docx,.png,.jpg,.jpeg"
          className="hidden"
          id="file-upload"
        />
        <label
          htmlFor="file-upload"
          className="inline-block bg-teal-600 text-white px-6 py-2 rounded-lg cursor-pointer hover:bg-teal-700 transition"
        >
          {t('chooseFile')}
        </label>
      </div>

      {file && (
        <div className="mt-4 p-4 bg-gray-50 rounded-lg">
          <div className="flex justify-between items-center mb-2">
            <span className="font-medium text-gray-800">{file.name}</span>
            <span className="text-sm text-gray-600">
              {(file.size / 1024 / 1024).toFixed(2)} MB
            </span>
          </div>
          <button
            onClick={handleUpload}
            disabled={uploading}
            className="w-full bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition disabled:opacity-50"
          >
            {uploading ? t('uploading') : t('upload')}
          </button>
        </div>
      )}

      {error && (
        <div className="mt-4 p-3 bg-red-50 border border-red-200 text-red-800 rounded-lg text-sm">
          {error}
        </div>
      )}

      {uploading && progress > 0 && (
        <div className="mt-4">
          <div className="w-full bg-gray-200 rounded-full h-2">
            <div
              className="bg-teal-600 h-2 rounded-full transition-all"
              style={{ width: `${progress}%` }}
            />
          </div>
        </div>
      )}
    </div>
  );
}
```

```ts
// app/api/admin/upload/route.ts
import { auth } from '@clerk/nextjs';
import { NextResponse } from 'next/server';
import prisma from '@/lib/prisma';

export async function POST(request: Request) {
  try {
    const { userId, sessionClaims } = auth();

    if (!userId || sessionClaims?.metadata?.role !== 'instructor') {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 403 });
    }

    const formData = await request.formData();
    const file = formData.get('file') as File;
    const studentId = formData.get('studentId') as string;

    if (!file || !studentId) {
      return NextResponse.json({ error: 'Missing file or studentId' }, { status: 400 });
    }

    // Validate file size (50MB)
    if (file.size > 50 * 1024 * 1024) {
      return NextResponse.json({ error: 'File size exceeds 50MB limit' }, { status: 400 });
    }

    // Convert file to Buffer
    const bytes = await file.arrayBuffer();
    const buffer = Buffer.from(bytes);

    // Create resource record
    const resource = await prisma.resource.create({
      data: {
        filename: file.name,
        mimeType: file.type || 'application/octet-stream',
        fileSize: file.size,
        fileData: buffer,
        studentId: studentId
      }
    });

    return NextResponse.json({ resource: { id: resource.id, filename: resource.filename } });
  } catch (error) {
    console.error('Upload error:', error);
    return NextResponse.json({ error: 'Failed to upload file' }, { status: 500 });
  }
}
```

### Translation Keys Example
```json
// messages/en.json
{
  "admin": {
    "upload": {
      "dragDrop": "Drag files here or click to browse",
      "supportedTypes": "Supported: PDF, PGN, TXT, DOCX, PNG, JPG (Max 50MB)",
      "chooseFile": "Choose File",
      "upload": "Upload",
      "uploading": "Uploading...",
      "successMessage": "File uploaded successfully!",
      "errorFileSize": "File size exceeds 50MB limit",
      "errorFileType": "Unsupported file type",
      "errorUpload": "Failed to upload file. Please try again."
    }
  }
}
```

### Testing
- **Upload PDF:** Upload a PDF file, verify it stores and displays
- **Upload PGN:** Upload a PGN chess file, verify it works
- **File Size Limit:** Try uploading file >50MB, verify error message
- **Unsupported Type:** Try uploading .exe file, verify error
- **Progress Indicator:** Watch progress bar during upload
- **Student Portal:** Verify file appears in student's resource list immediately
- **Delete:** Click delete button, confirm, verify file removed

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | 1.0 | Initial story creation | John (PM Agent) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
