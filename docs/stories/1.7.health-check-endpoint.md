# Story 1.7: Health Check Endpoint & Deployment Validation

## Status
Draft

## Story
**As a** developer,
**I want** health check API endpoint that verifies database connectivity and returns application status,
**so that** I can confirm the entire stack (frontend, API routes, database) works end-to-end in production.

## Acceptance Criteria
1. API route created at `/api/health` (GET request)
2. Endpoint queries database (simple `SELECT 1` or Prisma query) to verify connectivity
3. Returns JSON response with status: `{ "status": "healthy", "database": "connected", "timestamp": "..." }`
4. Returns appropriate error response if database unreachable
5. Endpoint accessible in both local development and production deployment
6. Response time logged for performance monitoring
7. Homepage updated to include link to health check (for testing purposes)

## Tasks / Subtasks
- [ ] Create health check API route (AC: 1)
  - [ ] Create app/api/health/route.ts
  - [ ] Setup GET request handler
- [ ] Add database connectivity check (AC: 2)
  - [ ] Import PrismaClient
  - [ ] Execute simple query (SELECT 1 or prisma.$queryRaw)
  - [ ] Handle connection errors
- [ ] Implement success response (AC: 3)
  - [ ] Return JSON with status, database, timestamp
  - [ ] Set HTTP 200 status code
  - [ ] Format timestamp in ISO 8601
- [ ] Implement error response (AC: 4)
  - [ ] Catch database connection errors
  - [ ] Return JSON with error status
  - [ ] Set HTTP 500 status code
- [ ] Test in local environment (AC: 5)
  - [ ] Visit http://localhost:3000/api/health
  - [ ] Verify successful response
  - [ ] Test with database disconnected
- [ ] Test in production (AC: 5)
  - [ ] Deploy to Vercel
  - [ ] Visit production /api/health endpoint
  - [ ] Verify response
- [ ] Add response time logging (AC: 6)
  - [ ] Log execution time
  - [ ] Include in response or server logs
- [ ] Update homepage (AC: 7)
  - [ ] Add link to /api/health
  - [ ] Label as "Health Check" or "Status"

## Dev Notes

### Health Check Implementation

```typescript
// app/api/health/route.ts
import { NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';

export async function GET() {
  const startTime = Date.now();

  try {
    // Test database connectivity
    await prisma.$queryRaw`SELECT 1`;

    const responseTime = Date.now() - startTime;

    return NextResponse.json({
      status: 'healthy',
      database: 'connected',
      timestamp: new Date().toISOString(),
      responseTime: `${responseTime}ms`
    }, { status: 200 });

  } catch (error) {
    const responseTime = Date.now() - startTime;

    return NextResponse.json({
      status: 'unhealthy',
      database: 'disconnected',
      timestamp: new Date().toISOString(),
      responseTime: `${responseTime}ms`,
      error: error instanceof Error ? error.message : 'Unknown error'
    }, { status: 500 });
  }
}
```

### Prisma Client Setup
```typescript
// lib/prisma.ts
import { PrismaClient } from '@prisma/client';

const globalForPrisma = global as unknown as { prisma: PrismaClient };

export const prisma = globalForPrisma.prisma || new PrismaClient();

if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;
```

### Expected Responses

**Success (HTTP 200):**
```json
{
  "status": "healthy",
  "database": "connected",
  "timestamp": "2025-10-24T12:00:00.000Z",
  "responseTime": "45ms"
}
```

**Error (HTTP 500):**
```json
{
  "status": "unhealthy",
  "database": "disconnected",
  "timestamp": "2025-10-24T12:00:00.000Z",
  "responseTime": "2050ms",
  "error": "Connection timeout"
}
```

### Testing
- **Local Test:** Run dev server and visit /api/health
- **Database Disconnect Test:** Stop Railway database temporarily and verify error response
- **Production Test:** Deploy and verify production endpoint works
- **Performance Test:** Check response time is <200ms in healthy state

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | 1.0 | Initial story creation | John (PM Agent) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
